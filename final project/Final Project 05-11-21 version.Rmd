---
title: "Data Mining Final Project"
author: "Anuka Revi and Maria Gilbert"
date: "5/13/2021"
output: 
  pdf_document:
    includes:
      in_header: my_header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE,cache=TRUE,include=FALSE)
```


```{r}
library(tidyverse)
library(janitor)
library(xgboost)
library(skimr)
library(data.table)
library(ggcorrplot)
library(psych)
library(dplyr)
library(ggplot2)
library(scales)
library(FNN)
library(class)
library(rsample)
library(caret)
library(modelr)
library(parallel)
library(foreach)
library(randomForest)
library(gbm)
library(pdp)
library(glmnet)
```

# **Predicting Birth weight for Babies**

## **Abstract**

Using data from the National Bureau of Economic Research on births in 2018, we created a model that aims to predict a baby's weight at birth, based on information that would be known prior to the baby being born. 

## **Introduction**

Baby announcements are sweet and memorable. Expecting parents usually know their approximate due date at the beginning of the pregnancy, and learn about their baby's gender at around 20 weeks. While the gender, time of birth, and name of the new baby are all exciting and great news for the entire family to have, pediatricians focus mostly on babies' development, growth, and weight. Estimating a baby's weight in particular is very important, since an unusually high birth weight can pose serious injuries to the baby and its mother, and an unusually low birth weight is associated with many pediatric health conditions. \

Ultrasounds are often used to estimate a baby's weight prior to birth, but they are not always accurate. When I was over 40 weeks pregnant, my doctor told me that the baby was an average size and that I did not need to be induced. However, my daughter was born at over 8.9 lbs which was significantly larger than the estimated size, and it made my delivery more complicated. So while we were exploring project ideas, we came across the NBER natality birth data from 2018, which contains information about 50,000 births. Our goal is to predict the birth weight of a full-term baby (37+ weeks). If our model can be used by doctors to better estimate babies' weights at birth, this can make deliveries easier, reduce complications, and maybe even decrease the rate of maternal mortality. It is interesting to see how machine learning tools can help us estimate the birth weight. 

\newpage
## **Data Exploration**

Our data set contains 50,000 randomly chosen samples from 2018 U.S. birth certificate data
(<https://www.nber.org/research/data/vital-statistics-natality-birth-data>), with 42 variables:
- X: a unique identifier\

- birth_month: an integer from 1 to 12, indicating the month of the birth\

- birth_time: an integer from 0 to 2359, indicating the time of birth\

- sex: a factor with two levels, for male and female\

- birth_weight: the birth weight (in grams). This is the variable we are hoping to estimate\

- mother_age: an integer indicating the age (in years) of the mother\

- mother_birthplace: a factor with three levels, indicating the mother was born inside the U.S., outside the U.S., or if this is unknown\

- hospital: a factor with three levels, indicating whether the baby was born in a hospital or not, or if this is unknown\

- mother_race: a factor with six levels, indicating whether the race of the mother is white, black, American Indian/Alaskan Native, Asian, Native Hawaiian and other Pacific Islander, or mixed race\

- mother_maritalstatus: a factor with three levels, indicating whether the mother is married, unmarried, or if this is unknown\

- mother_education: a factor with eight levels, indicating the level of education of the mother, categorized into 8th grade or less, 9th to 12th grade with no diploma, high school graduate or equivalent, some college but no degree, associate degree, bachelor's degree, master's degree, or doctorate/professional degree\

- father_combinedage: an integer indicating the age (in years) of the father\

- father_race: a factor with six levels, indicating whether the race of the father is white, black, American Indian/Alaskan Native, Asian, Native Hawaiian and other Pacific Islander, or mixed race\

- father_education: a factor with eight levels, indicating the level of education of the father, categorized into 8th grade or less, 9th to 12th grade with no diploma, high school graduate or equivalent, some college but no degree, associate degree, bachelor's degree, master's degree, or doctorate/professional degree\

- priorlive: an integer indicating the number of prior live births the mother has had\

- priorterm: an integer indicating the number of prior term births the mother has had\

- time_sincelastbirth: a factor indicating whether the mother's last birth occurred less than 18 months before the current birth, 18 months to under 2 years before the current birth, 2 years to under 4 years before the current birth, 4 years to under 6 years before the current birth, greater than 6 years before the current birth, or whether this is N/A or unknown\

- prenatal_visits: an integer indicating the number of prenatal care visits\

- wic: a factor indicating whether the mother participates in WIC (Special Supplemental Nutrition Program for Women, Infants, and Children) or not, or whether this is unknown\

- f_cigs_1: a factor indicating whether the mother smoked during the first trimester\

- f_cigs_2: a factor indicating whether the mother smoked during the second trimester\

- f_cigs_3: a factor indicating whether the mother smoked during the third trimester\

- m_ht_in: an integer indicating the height (in inches) of the mother\

- bmi: the BMI (Body Mass Index) of the mother\

- prepreg_weight: an integer indicating the weight (in pounds) of the mother before the current pregnancy\

- wtgain: an integer indicating the amount of weight (in pounds) the mother gained throughout the pregnancy\

- gest_diabetes: a factor indicating whether the mother has gestational diabetes or not, or if this is unknown\

- hypertension_eclampsia: a factor indicating whether the mother has hypertension eclampsia, or if this is unknown\

- infertility_treatment: a factor indicating whether the mother underwent fertility treatment for the current pregnancy, or if this is unknown\

- previous_cesarian: a factor indicating whether the mother has previously given birth via Cesarian section, or if this is unknown\

- no_infections: a factor indicating whether the mother has any infections\

- labor_induced: a factor indicating whether the labor was induced or not, or if this is unknown\

- anesthesia: a factor indicating whether the mother was given anesthesia for the birth or not, or whether this is unknown\

- delivery_method: a factor indicating whether the birth was vaginal, C-section, or if this is unknown\

- ruptured_uterus: a factor indicating whether the mother experienced uterine rupture during birth or not, or if this is unknown\

- perineal_laceration: a factor indicating whether the mother experienced perineal lacerations (known commonly as vaginal tears) during the birth or not, or if this is unknown\

- attend: a factor indicating whether the birth was attended by a medical doctor, a midwife, or if this is unknown\

- apgar5: a integer indicating the baby's APGAR (Appearance, Pulse, Grimace, Acitivty, and Respiration) score five minutes after birth. This score is used as a summary of the baby's overall health and is used to determine whether the baby needs medical attention. It is an integer ranging from 0 to 10, with 0 being an emergency and 10 being ideal\

- plurality: a factor indicating whether or not the birth was a multiple birth\

- combined_gestation: an integer indicating which week of gestation the baby was born at\

- breastfed: a factor indicating whether the baby was breastfed after birth or not, or if this is unknown\

Many of these variables will not be relevant in our models, because of the way that they might be caused by the birth weight, or emerge after the birth weight would already be known. We will be excluding breastfed and apgar5 because these emerge after the birth has already occurred. We will also be excluding perineal_laceration, ruptured_uterus, delivery_method, and hypertension_eclampsia, since these emerge during birth, and are influenced by the weight of the baby. Finally, we will be excluding all data on plural births, as well as pre-term births. This way we can control for the fact that pre-term births nearly always have low birth weight.

\newpage

In our initial exploration of the data, we evaluated the correlations between all variables, and examined the variance in values for some selected variables. Figure 1 shows the correlations between our variables.\

```{r}
#load data 
birthweight_new <- read.csv("~/Downloads/birthweight_new.csv", stringsAsFactors=TRUE, header=TRUE)
### Create list of columns with missing values
na99<-c("combgest", "apgar5", "wtgain", "m_ht_in",
        "previs", "illb_r11", "priorterm", "priorlive", "fagecomb")
#na999<-("pwgt_r")
na9999<-c("dbwt", "dob_tt")
#na99.9<- ("bmi")
### Replace missing values with NA
birthweight_new[ ,na99][birthweight_new[ ,na99] == 99] <- NA
birthweight_new[ ,na9999][birthweight_new[ ,na9999] == 9999] <- NA
birthweight_new$pwgt_r[birthweight_new$pwgt_r==999]<-NA
birthweight_new$bmi[birthweight_new$bmi==99.9]<-NA
birthweight_new$no_infec[birthweight_new$no_infec==9]<-NA
birthweight_new$dmeth_rec[birthweight_new$dmeth_rec==9]<-NA
birthweight_new$attend[birthweight_new$attend==9]<-NA
birthweight_new$illb_r11[birthweight_new$illb_r11==88]<-NA
# convert some variables as factors with levels
birthweight_new <- rename(birthweight_new,
                              birth_month = dob_mm,
                              birth_time = dob_tt,
                              birth_weight = dbwt,
                              mother_age = mager,
                              mother_birthplace = mbstate_rec,
                              hospital = bfacil3,
                              mother_race = mrace6,
                              mother_maritalstatus = dmar,
                              mother_education = meduc,
                              father_combinedage = fagecomb,
                              father_race = frace6,
                              father_education = feduc,
                              time_sincelastbirth = illb_r11,
                              prenatal_visits = previs,
                              prepreg_weight = pwgt_r,
                              gest_diabetes = rf_gdiab,
                              hypertension_eclampsia = rf_ehype,
                              infertility_treatment = rf_inftr,
                              previous_cesarian = rf_cesar,
                              no_infections = no_infec,
                              labor_induced = ld_indl,
                              anesthesia = ld_anes,
                              delivery_method = dmeth_rec,
                              ruptured_uterus = mm_rupt,
                              perineal_laceration = mm_plac,
                              plurality = dplural,
                              combined_gestation = combgest,
                              under_37weeks = gestrec3,
                              breastfed = bfed
)
#create factors 
birthweight_new$mother_race <- as.factor(birthweight_new$mother_race)
birthweight_new$mother_birthplace <- as.factor(birthweight_new$mother_birthplace)
birthweight_new$mother_education <- as.factor(birthweight_new$mother_education)
birthweight_new$hospital <- as.factor(birthweight_new$hospital)
birthweight_new$father_race <- as.factor(birthweight_new$father_race)
birthweight_new$mother_maritalstatus <- as.factor(birthweight_new$mother_maritalstatus)
birthweight_new$delivery_method <- as.factor(birthweight_new$delivery_method)
birthweight_new$attend <- as.factor(birthweight_new$attend)
birthweight_new$gest_diabetes <- as.factor(birthweight_new$gest_diabetes)
birthweight_new$hypertension_eclampsia <- as.factor(birthweight_new$hypertension_eclampsia)
birthweight_new$infertility_treatment <- as.factor(birthweight_new$infertility_treatment)
birthweight_new$previous_cesarian <- as.factor(birthweight_new$previous_cesarian)
birthweight_new$labor_induced <- as.factor(birthweight_new$labor_induced)
birthweight_new$anesthesia <- as.factor(birthweight_new$anesthesia)
birthweight_new$ruptured_uterus <- as.factor(birthweight_new$ruptured_uterus)
birthweight_new$perineal_laceration <- as.factor(birthweight_new$perineal_laceration)
birthweight_new$breastfed <- as.factor(birthweight_new$breastfed)
#remove time since last birth from the data, not really useful for our analysis 
birthweight_new$time_sincelastbirth <-NULL
#take care of missing values since missing data in total is less that 10% we will not impute and just drop NA values
birthweight_new<-na.omit(birthweight_new)
## **use lubridate to have months and time in correct R format
#
#try this  birthweight_new<-birthweight_new %>% 
#######****** #STILL CANT MAKE THIS WORK
#birthweight_new<-birthweight_new%>%
  #mutate(time=lubridate::hm(birth_time, label=FALSE))
         
         #Error in `$<-.data.frame`(`*tmp*`, time, value = new("Period", .Data = c(NA_real_,  : 
#  replacement has 37707 rows, data has 37706
#> dim(birthweight_new)
#[1] 37706    42
birthweight_new$birth_month<-lubridate::month(birthweight_new$birth_month, label=FALSE)
levels(birthweight_new$mother_race) <- list("white"="10","black"="20","asian"="40","NHOPI"="50","more than 1 race"="60")
levels(birthweight_new$mother_birthplace) <- list("born in the U.S."="1","born outside the U.S."="2","unknown"="3")
levels(birthweight_new$mother_education) <- list("1-8 grade"="1","9-12 grade no HS"="2","HS diploma"="3","some college"="4","AA AS"="5","BA BS"="6","MA MS"="7","PhD EdD"="8")
levels(birthweight_new$hospital) <- list("Hospital"="1","Not Hospital"="2","Unknown"="3")
levels(birthweight_new$father_race) <- list("white"="1","black"="2","AIAN"="3","asian"="4","NHOPI"="5","more than 1 race"="6","unknown"="9")
levels(birthweight_new$mother_maritalstatus) <- list("married"="1","unmarried"="2","unmarried"="3","unknown"="9")
#(birthweight_new$time_sincelastbirth) <- list("less than 18 months"="00","less than 18 months"="01","less than 2 years"="02","less than 2 years"="03","less than 4 years"="04","less than 4 years"="05","less than 6 years"="06","less than 6 years"="07","unknown"="99")
levels(birthweight_new$delivery_method) <- list("Vaginal"="1","Vaginal"="2","Vaginal"="5","C-section"="3","C-section"="4","C-section"="6")
levels(birthweight_new$attend) <- list("Doctor"="1","Doctor"="2","midwife"="3","midwife"="4","other"="5")  
week37to40 <- birthweight_new %>%
  filter(!is.na(birth_weight)) %>%
  filter(combined_gestation=="37" | combined_gestation=="38" | combined_gestation=="39"| combined_gestation=="40") %>%
  filter(plurality=="1")
```

```{r}
#is.na(week37to40)%>%table()
#  FALSE    TRUE 
#1157674    2134 
NAcol <- which(colSums(is.na(week37to40)) > 0)
sort(colSums(sapply(week37to40[NAcol], is.na)), decreasing = TRUE)
week37to40 <- na.omit(week37to40)
```

```{r}
#correlation for variables 
num_cols <- unlist(lapply(week37to40, is.numeric))         # Identify numeric columns
data_num <- week37to40[, num_cols]   
data_num <-na.omit(data_num)
data_num$X <- NULL
data_num$birth_month <- NULL
data_num$birth_time <- NULL
data_num$father_education <- NULL
corr<-cor(data_num,use="pairwise.complete.obs")%>%round(2)
```

```{r, include=TRUE, fig.cap="Correlogram"}
ggcorrplot(corr, hc.order = FALSE,
           type="upper",
           outline.color="white", 
           title="Correlogram of birthweight variables")
```

As we can see, f_cigs_1, f_cigs_2, and f_cigs_3 all have the same correlations with the other variables. The strongest correlations with birth weight are weeks of gestation (even with pre-term births filtered out!), weight gain, pre-pregnancy weight, BMI of the mother, and the height of the mother, all having a positive correlation with birth weight.

\newpage

Next, we aimed to examine the distributions of some of our variables. Figure 2 shows the distribution of actual birth weights from our data. \

```{r, include=TRUE, fig.cap="Birth weight Distribution"}
  
#histogram of baby weight for gestational weeks 37-40
g <- ggplot(week37to40, aes(birth_weight)) + scale_fill_brewer(palette = "Spectral")
g + geom_histogram(aes(fill=sex),
                   binwidth = 200,
                   col="black",
                   
) + labs(title="Histogram of Birthweight for gestational weeks 37 to 40",
         subtitle="Birthweight and Sex of the infant")  + scale_x_continuous(name="Birthweight, in grams",breaks=seq(0,6000,500)) + scale_y_continuous(name="Number of births",breaks=seq(0,9000,1000))
```

Figure 3 shows distributions of selected variables within our data relating to the mother's medical history. 

\newpage

```{r, include=TRUE, fig.cap="Maternal health history distributions",fig.height=8}
library(hrbrthemes)
s1=ggplot(week37to40, aes(x=as.factor(combined_gestation))) +
  geom_histogram(stat='count',fill="cornflowerblue") + labs(x='Weeks of Gestation')
s2=ggplot(week37to40, aes(x=wtgain)) + 
  geom_density() +
  theme_classic()+ labs(x='Weight Gain During Pregnancy') + scale_x_continuous(breaks=seq(0,100,10))
s3=ggplot(week37to40, aes(x=as.factor(m_ht_in))) +
  geom_histogram(stat='count',fill="cornflowerblue") + labs(x='Mother Height (Inches)') + scale_x_discrete(labels=c(" ","56"," ","58"," ","60"," ","62"," ","64"," ","66"," ","68"," ","70"," ","72"," ","74"," "),limits=c("55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75"))
s4=ggplot(week37to40, aes(x=mother_age)) + 
  geom_density() +
  theme_classic()+ labs(x='Mother Age') + scale_x_continuous(breaks=seq(15,50,5))
s5=ggplot(week37to40, aes(x=prepreg_weight)) + 
  geom_density() +
  theme_classic()+ labs(x='Pre-Pregnancy Weight') + scale_x_continuous(breaks=seq(80,360,40))
s6=ggplot(week37to40, aes(x=as.factor(prenatal_visits))) + 
  geom_histogram(stat='count',fill="cornflowerblue") + labs(x='Prenatal Care Visits') + scale_x_discrete(labels=c("0"," "," "," "," ","5"," "," "," "," ","10"," "," "," "," ","15"," "," "," "," ","20"," "," "," "," ","25"," "," "," "," ","30"),limits=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30"))
s7=ggplot(data=week37to40, aes(x=as.factor(mother_race))) +
  geom_histogram(stat='count') + labs(x='Mother Race')
s8=ggplot(data=week37to40, aes(x=as.factor(mother_maritalstatus))) +
  geom_histogram(stat='count') + labs(x='Mother Marital Status')
s9=ggplot(data=week37to40, aes(x=as.factor(mother_education))) +
  geom_histogram(stat='count') + labs(x='Mother Education Level') + scale_x_discrete(labels=c("1-8","some","HS","some","Assoc","Bach","Mast","PhD"),limits=c("1-8 grade","9-12 grade no HS","HS diploma","some college","AA AS","BA BS","MA MS","PhD EdD"))
s10=ggplot(data=week37to40, aes(x=as.factor(mother_birthplace))) +
  geom_histogram(stat='count') + labs(x='Mother Birthplace') + scale_x_discrete(labels=c("U.S.","other"),limits=c("born in the U.S.","born outside the U.S."))

source("http://peterhaschke.com/Code/multiplot.R")
multiplot(s1,s2,s3,s4,s5,s6,cols=2)
```

\newpage

Figure 4 shows distributions of selected variables within our data relating to the mother's demographics.

```{r,include=TRUE,fig.cap="Maternal demographic distributions"}
multiplot(s7,s8,s9,s10,cols=2)
```

The x-axis labels for Mother Education Level have been abbreviated for readability. 
- "1-8" = up to 8th grade
- "some" = some high school but no diploma
- "HS" = high school diploma or equivalent (e.g., GED)
- "some" = some college but no degree
- "Assoc" = Associate degree
- "Bach" = Bachelor's degree
- "Mast" = Master's degree
- "PhD" = Doctorate (PhD, EdD) or professional degree

Now, we want to look at the relationships between some of these variables and the birth weight of the baby. Figure 5 shows some of these relationships, with LOESS (local regression) trend lines. The vertical black lines show the mean values within our data of weeks of gestation, weight gain, pre-pregnancy weight, and height.

```{r,include=TRUE,fig.cap="Maternal health history and birth weight",fig.height=8}
g1=ggplot(data=week37to40, aes(x=as.factor(combined_gestation), y=birth_weight))+geom_boxplot(color="black",fill="grey")+ggtitle("Weeks of gestation")+xlab("Weeks of gestation")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))

g2=ggplot(data=week37to40, aes(x=as.factor(wtgain), y=birth_weight))+stat_summary(geom='bar',fun='mean',fill="cornflowerblue")+ggtitle("Pregnancy weight gain")+xlab("Weight gain (lb)")+ylab("Birth weight (grams)") +scale_x_discrete(labels=c("0"," "," "," "," ","5"," "," "," "," ","10"," "," "," "," ","15"," "," "," "," ","20"," "," "," "," ","25"," "," "," "," ","30"," "," "," "," ","35"," "," "," "," ","40"," "," "," "," ","45"," "," "," "," ","50"," "," "," "," ","55"," "," "," "," ","60"," "," "," "," ","65"," "," "," "," ","70"," "," "," "," ","75"," "," "," "," ","80"," "," "," "," ","85"," "," "," "," ","90"," "," "," "," ","95"," "," "," "," ","100"), limits=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100"))+scale_y_continuous(breaks=seq(1000,6000,500))

g3=ggplot(data=week37to40, aes(x=as.factor(prepreg_weight), y=birth_weight))+stat_summary(geom='bar',fun='mean',fill="cornflowerblue")+ggtitle("Pre-pregnancy weight")+xlab("Pre-pregnancy weight (lb)")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))+scale_x_discrete(labels=c(" ","100"," ","150"," ","200"," ","250"," ","300"," ","350"," "),limits=c("75","100","125","150","175","200","225","250","275","300","325","350","375"))

g4=ggplot(data=week37to40, aes(x=as.factor(m_ht_in), y=birth_weight))+stat_summary(geom='bar',fun='mean',fill="cornflowerblue")+ggtitle("Mother's height")+xlab("Mother's height (in)")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))+scale_x_discrete(labels=c(" ","56"," ","58"," ","60"," ","62"," ","64"," ","66"," ","68"," ","70"," ","72"," ","74"," "),limits=c("55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75"))

g5=ggplot(data=week37to40, aes(x=combined_gestation, y=birth_weight))+stat_summary(geom='bar',fun='mean',fill="cornflowerblue")+ggtitle("Weeks of gestation")+xlab("Weeks of gestation")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))+scale_x_continuous(breaks=seq(37,40,1))+geom_vline(xintercept=mean(week37to40$combined_gestation),size=1,color="black")

g6=ggplot(data=week37to40, aes(x=wtgain, y=birth_weight))+geom_point(color="cornflowerblue")+geom_smooth(method = "loess", se=TRUE, color="navy")+ggtitle("Pregnancy weight gain")+xlab("Weight gain (lb)")+ylab("Birth weight (grams)")+scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(breaks=seq(1000,6000,500))+geom_vline(xintercept=mean(week37to40$wtgain),size=0.5,color="black")

g7=ggplot(data=week37to40, aes(x=prepreg_weight, y=birth_weight))+geom_point(color="cornflowerblue")+geom_smooth(method = "loess", se=TRUE, color="navy")+ggtitle("Pre-pregnancy weight")+xlab("Pre-pregnancy weight (lb)")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))+scale_x_continuous(breaks=seq(80,360,40))+geom_vline(xintercept=mean(week37to40$prepreg_weight),size=0.5,color="black")

g8=ggplot(data=week37to40, aes(x=m_ht_in, y=birth_weight))+geom_point(color="cornflowerblue")+geom_smooth(method = "loess", se=TRUE, color="navy")+ggtitle("Mother's height")+xlab("Mother's height (in)")+ylab("Birth weight (grams)")+scale_y_continuous(breaks=seq(1000,6000,500))+scale_x_continuous(breaks=seq(54,76,2))+geom_vline(xintercept=mean(week37to40$m_ht_in),size=0.5,color="black")

source("http://peterhaschke.com/Code/multiplot.R")
multiplot(g1,g2,g3,g4,g5,g6,g7,g8,cols=2)
```


Prior to analysis, we converted categorical variables into factors and re-coded them in accordance with the code book provided by NBER. We replaced unknown variables that were coded as 99, 999, or 9999 with NA values and renamed variables more intuitively for readers. Since we were interested in the birth weight outcome, we decided to filter the data and focus on babies who were born on 37 to 40 weeks mark, since there is a strong causal relationship between week of gestation and the potential birth weight outcome. As we would expect, babies who are born at 37-40 weeks weigh more than premature babies. 

In our processed data *week37to40* we have 2,134 missing values out of the total 1,159,808 observed values. The variable mother_race contains 2,061 missing values. Since these NA values are close to 10% of our 26,162 observations, we had to ignore the mother's race in our analysis. Additionally, we had eliminated time_sincelastbirth due to having mostly NA values in the original data set.

## **Methods and Results**

We first used a random forest model to evaluate variable importance. 

Although the correlations provided a comprehensive overview of the most important numeric variables and multicollinearity among them, we also used a random forest model to get an overview that would include the categorical variables. A random forest model works by creating a multitude of decision trees and selecting the mean training value at each node. This method allows us to find the variable importance without much effort or parameter tuning. As we would expect, some of the most important variables are combined_gestation, wtgain, prepreg_weight, mother's bmi, height, race, age,  prior live births, and sex of the baby. Figure 6 shows the variable importance plot that resulted from our random forest. 

```{r,include=TRUE,fig.cap="Variable Importance Plot",cache=TRUE}
##Random Forest 
set.seed(1234)
week37to40_split = initial_split(week37to40)
n = nrow(week37to40)
n_train = floor(0.8*n)
n_test = n - n_train
train_cases = sample.int(n, size=n_train, replace=FALSE)
week37to40_train = training(week37to40_split)
week37to40_test = testing(week37to40_split)

week37to40_train$labor_induced <- NULL
week37to40_train$perineal_laceration <- NULL
week37to40_train$X <- NULL
week37to40_train$birth_time <- NULL
week37to40_train$hospital <- NULL
week37to40_train$hypertension_eclampsia <- NULL
week37to40_train$labor_induced <- NULL
week37to40_train$anesthesia <- NULL
week37to40_train$delivery_method <- NULL
week37to40_train$ruptured_uterus <- NULL
week37to40_train$perineal_laceration <- NULL
week37to40_train$attend <- NULL
week37to40_train$under_37weeks <- NULL
week37to40_train$breastfed <- NULL

week37to40_test$labor_induced <- NULL
week37to40_test$perineal_laceration <- NULL
week37to40_test$X <- NULL
week37to40_test$birth_time <- NULL
week37to40_test$hospital <- NULL
week37to40_test$hypertension_eclampsia <- NULL
week37to40_test$labor_induced <- NULL
week37to40_test$anesthesia <- NULL
week37to40_test$delivery_method <- NULL
week37to40_test$ruptured_uterus <- NULL
week37to40_test$perineal_laceration <- NULL
week37to40_test$attend <- NULL
week37to40_test$under_37weeks <- NULL
week37to40_test$breastfed <- NULL

forest1 = randomForest(birth_weight ~ . - apgar5, distribution="gaussian",data=week37to40_train, n.trees=100, importance=TRUE)
imp_forest1<-importance(forest1)
imp_DF <- data.frame(Variables = row.names(imp_forest1), MSE = imp_forest1[,1])
imp_DF <- imp_DF[order(imp_DF$MSE, decreasing = TRUE),]
ggplot(imp_DF[1:20,], aes(x=reorder(Variables, MSE), y=MSE, fill=MSE)) + geom_bar(stat = 'identity') + labs(x = 'Variables', y= '% increase MSE if variable is randomly permuted') + coord_flip() + theme(legend.position="none") + ggtitle("Variable Importance from Random Forest")
```

The RMSE of this random forest model is:

```{r,include=TRUE}
yhat_test = predict(forest1, week37to40_test)
err_forest <- rmse(forest1,week37to40_test)
print(paste("RMSE = ", err_forest))
```

We were interested in creating models that would predict two different outcomes. One would be the birth weight in grams, and another would be whether the baby was born with a low weight (under 2,500 grams or 5.5 pounds), a high weight (over 4,000 grams or 8.8 pounds), or a normal weight (2,500 to 4,000 grams). 

\

## **Part A: Models to Predict Whether Baby Will be Above or Below Average Weight

In order to predict whether a baby would be born with a low weight, normal weight, or high weight, we created two xgboost models. The first determined whether the baby would be low weight or not, and the second determined whether the baby would be high weight or not. The following shows the feature importance plot of the first xgboost model, which predicts whether or not a baby will be low weight. We calculated the test error of this model to be:

```{r}
week37to40_new<-week37to40%>%
  mutate(underweight=as.factor(ifelse(birth_weight<2500, "underweight", "not underweight")),
         agediscrete=as.factor(round(mother_age/10,0)),
         risk=as.factor(ifelse(mother_age>35, "high risk", "low risk")))
#remove X because there is nothing to learn from X that stands as ID 
week37to40_new$X<-NULL
week37to40_new$birth_weight <- NULL
week37to40_new$labor_induced <- NULL
week37to40_new$perineal_laceration <- NULL
week37to40_new$birth_time <- NULL
week37to40_new$hospital <- NULL
week37to40_new$hypertension_eclampsia <- NULL
week37to40_new$labor_induced <- NULL
week37to40_new$anesthesia <- NULL
week37to40_new$delivery_method <- NULL
week37to40_new$ruptured_uterus <- NULL
week37to40_new$perineal_laceration <- NULL
week37to40_new$attend <- NULL
week37to40_new$under_37weeks <- NULL
week37to40_new$breastfed <- NULL
week37to40_new$agediscrete <- NULL
week37to40_new$apgar5 <- NULL
#train test split with caret 
set.seed(123)
week37to40_new_split = initial_split(week37to40_new)
nrow = nrow(week37to40_new)
n_train_new = floor(0.8*nrow)
n_test_new = nrow - n_train_new
train_cases = sample.int(nrow, size=n_train_new, replace=FALSE)
week37to40_new_train = training(week37to40_new_split)
week37to40_new_test = testing(week37to40_new_split)
#unlinke GLM that assumes that feautures are uncorrelated in order to predict more accurate outcomes. decision tree algorithms including boosted trees are robust to these feautures. thus we do nothave to worry about correlated feautures!
# **ONE HOT ENCODING***
#transform categorical data to dummy variables (the purpose is to transform each value of the each categorical feauture into a binary feauture {0,1}.

library(Matrix)

sparse_matrix<-sparse.model.matrix(underweight~.-1, data = week37to40_new_train)
sparse_matrix_test<-sparse.model.matrix(underweight~.-1, data=week37to40_new_test)
#create output numeric vector (not as a sparse matrix)
output_vector=as.numeric(week37to40_new_train$underweight=="underweight")
output_vector_test=as.numeric(week37to40_new_test$underweight=="underweight")

##build the model
bst_boost<-xgboost(data=sparse_matrix, label=output_vector, max.depth=4, eta=0.2, nthread=2, nround=10, objective="binary:logistic")
pred_boost<-predict(bst_boost, sparse_matrix_test)
err_boost<-as.numeric(sum(as.integer(pred_boost>0.5)!=output_vector_test))/length(output_vector_test)
```

```{r,include=TRUE}
print(paste("Test error = ", err_boost))
```

This means that about 97.5% of the time, this model is correct in predicting whether or not a baby will be born with a low weight. Figure 7 shows the feature importance of this model.

```{r,include=TRUE,fig.cap="Feature importance for low birth weight"}
importance_boost<-xgb.importance(model=bst_boost)
print(xgb.plot.importance(importance_matrix = importance_boost, top_n=10))
```

We created a similar model to predict if baby will be born with a high weight, and calculated the test error of this model to be:

```{r}
week37to40_new<-week37to40%>%
  mutate(overweight=as.factor(ifelse(birth_weight>4000, "overweight", "not overweight")),
         agediscrete=as.factor(round(mother_age/10,0)),
         risk=as.factor(ifelse(mother_age>35, "high risk", "low risk")))
#remove X because there is nothing to learn from X that stands as ID 
week37to40_new$X<-NULL
week37to40_new$birth_weight <- NULL
week37to40_new$labor_induced <- NULL
week37to40_new$perineal_laceration <- NULL
week37to40_new$birth_time <- NULL
week37to40_new$hospital <- NULL
week37to40_new$hypertension_eclampsia <- NULL
week37to40_new$labor_induced <- NULL
week37to40_new$anesthesia <- NULL
week37to40_new$delivery_method <- NULL
week37to40_new$ruptured_uterus <- NULL
week37to40_new$perineal_laceration <- NULL
week37to40_new$attend <- NULL
week37to40_new$under_37weeks <- NULL
week37to40_new$breastfed <- NULL
week37to40_new$agediscrete <- NULL
week37to40_new$apgar5 <- NULL
#train test split with caret 
set.seed(123)
week37to40_new_split = initial_split(week37to40_new)
nrow = nrow(week37to40_new)
n_train_new = floor(0.8*nrow)
n_test_new = nrow - n_train_new
train_cases = sample.int(nrow, size=n_train_new, replace=FALSE)
week37to40_new_train = training(week37to40_new_split)
week37to40_new_test = testing(week37to40_new_split)

sparse_matrix<-sparse.model.matrix(overweight~.-1, data = week37to40_new_train)
sparse_matrix_test<-sparse.model.matrix(overweight~.-1, data=week37to40_new_test)
#create output numeric vector (not as a sparse matrix)
output_vector=as.numeric(week37to40_new_train$overweight=="overweight")
output_vector_test=as.numeric(week37to40_new_test$overweight=="overweight")

##build the model
bst_boost<-xgboost(data=sparse_matrix, label=output_vector, max.depth=4, eta=0.2, nthread=2, nround=10, objective="binary:logistic")
pred_boost<-predict(bst_boost, sparse_matrix_test)
err_boost<-as.numeric(sum(as.integer(pred_boost>0.5)!=output_vector_test))/length(output_vector_test)
```

```{r,include=TRUE}
print(paste("Test Error = ", err_boost))
```

This means that about 91.7% of the time, this model is correct in predicting whether or not a baby will be born with a high weight. Figure 8 shows the feature importance of this model.

```{r,include=TRUE,fig.cap="Feature importance for high birth weight"}
importance_boost<-xgb.importance(model=bst_boost)
print(xgb.plot.importance(importance_matrix = importance_boost, top_n=10))
```

While weeks of gestation is the most important feature in telling whether the baby will be born with low weight (even considering only full term births), pre-pregnancy weight and pregnancy weight gain are the most important in telling whether the baby will be overweight. We can tell from this that there are some factors that are more important at the lower end of the spectrum of birth weight than those that are more important at the higher end of the spectrum. 

## **Part B: Predicting Actual Birth Weight in Grams** 

Now, our last model aims to predict the actual birth weight in grams. We tried several different types of models, but the two with the highest accuracy were lasso and step, with their accuracy levels being virtually identical. A lasso (Least Absolute Shrinkage and Selection Operator) model is from an algorithm that performs variable selection and regularization and then results in a regression model. A step model is from an algorithm that starts with a basic linear regression model and tests iterations with different interactions between the variables until it finds the optimal linear model. Because these models are similar in how they work, it is not surprising that we found similar RMSE (root mean squared error) in both of them. 

```{r}
week37to40_uncorr <- week37to40 %>% select(birth_weight,mother_age,birth_month,father_education,priorlive,priorterm,prenatal_visits,f_cigs_1,m_ht_in,bmi,wtgain,no_infections,combined_gestation,sex,mother_birthplace,mother_race,mother_maritalstatus,infertility_treatment,previous_cesarian)
set.seed(1234)
week37to40_split_uncorr = initial_split(week37to40_uncorr)
n_uncorr = nrow(week37to40_uncorr)
n_train_uncorr = floor(0.8*n_uncorr)
n_test_uncorr = n_uncorr - n_train_uncorr
train_cases_uncorr = sample.int(n_uncorr, size=n_train_uncorr, replace=FALSE)
week37to40_train_uncorr = training(week37to40_split_uncorr)
week37to40_test_uncorr = testing(week37to40_split_uncorr)

x.train <- data.matrix(week37to40_train_uncorr[,2:19])
y.train <- week37to40_train_uncorr$birth_weight
x.test <- data.matrix(week37to40_test_uncorr[,2:19])
y.test <- week37to40_test_uncorr$birth_weight

set.seed(12345)
cv.fit <- cv.glmnet(x.train,y.train,alpha=1)

coef(cv.fit,s="lambda.min")
opt.lambda <- cv.fit$lambda.min
```

```{r,include=TRUE,fig.cap="Lambda and MSE"}
plot(cv.fit)
```

```{r,include=TRUE}
print(paste("best lambda value is",opt.lambda))
```

```{r}
lasso.pred <- predict(cv.fit,newx=x.test,s="lambda.min")
rmse.test <- sqrt(mean((lasso.pred-y.test)^2))
```

```{r,include=TRUE}
print(paste("RMSE = ",rmse.test))
```

```{r}
coef.apprx <- coef(cv.fit,s=opt.lambda,exact=FALSE)
coef.exact <- coef(cv.fit,s=opt.lambda,exact=TRUE,x=x.train,y=y.train)
cbind2(coef.exact[which(coef.exact!=0)],coef.apprx[which(coef.apprx!=0)])
```

The relative error improvement of our final lasso model over the random tree that we used to examine variable importance was 

```{r,include=TRUE}
(err_forest - rmse.test)/err_forest
```

Not a significant improvement, but both models do a decent job at predicting the birth weight given the information available before the birth.

## **Conclusion**

We found that using only variables that would be known before a baby is born, it is possible to predict whether a baby will be low weight, normal weight, or high weight, and even to predict the actual numeric weight itself, all with modest to reasonable accuracy. This model could be used by doctors to supplement fetal weights estimated by ultrasound to get a more accurate guess for how much a baby will weigh at birth, and as a result, how likely it will be for the mother and/or baby to have complications during birth. 



