---
title: "Data Mining Final Project"
author: "Anuka Revi Maria Gilbert"
date: "4/13/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning= FALSE,
                      message=FALSE,
                      include=FALSE)
```


```{r}


library(tidyverse)
library(janitor)
library(xgboost)
library(skimr)
library(data.table)
library(ggcorrplot)
library(psych)
library(ggplot2)
library(dplyr)
library(caret)
library(lubridate)

library(scales)
library(FNN)
library(class)
library(rsample)
library(caret)
library(modelr)
library(parallel)
library(foreach)
library(randomForest)
library(gbm)
library(pdp)




#load data 

birthweight_new <- read.csv("~/GitHub/datamining_hw/final project/birthweight_new.csv", stringsAsFactors=TRUE, header=TRUE)


### Create list of columns with missing values
na99<-c("combgest", "apgar5", "wtgain", "m_ht_in",
        "previs", "illb_r11", "priorterm", "priorlive", "fagecomb")

#na999<-("pwgt_r")


na9999<-c("dbwt", "dob_tt")


#na99.9<- ("bmi")

### Replace missing values with NA

birthweight_new[ ,na99][birthweight_new[ ,na99] == 99] <- NA
birthweight_new[ ,na9999][birthweight_new[ ,na9999] == 9999] <- NA
birthweight_new$pwgt_r[birthweight_new$pwgt_r==999]<-NA
birthweight_new$bmi[birthweight_new$bmi==99.9]<-NA
birthweight_new$no_infec[birthweight_new$no_infec==9]<-NA
birthweight_new$dmeth_rec[birthweight_new$dmeth_rec==9]<-NA
birthweight_new$attend[birthweight_new$attend==9]<-NA
birthweight_new$illb_r11[birthweight_new$illb_r11==88]<-NA

# convert some variables as factors with levels

birthweight_new <- rename(birthweight_new,
                              birth_month = dob_mm,
                              birth_time = dob_tt,
                              birth_weight = dbwt,
                              mother_age = mager,
                              mother_birthplace = mbstate_rec,
                              hospital = bfacil3,
                              mother_race = mrace6,
                              mother_maritalstatus = dmar,
                              mother_education = meduc,
                              father_combinedage = fagecomb,
                              father_race = frace6,
                              father_education = feduc,
                              time_sincelastbirth = illb_r11,
                              prenatal_visits = previs,
                              prepreg_weight = pwgt_r,
                              gest_diabetes = rf_gdiab,
                              hypertension_eclampsia = rf_ehype,
                              infertility_treatment = rf_inftr,
                              previous_cesarian = rf_cesar,
                              no_infections = no_infec,
                              labor_induced = ld_indl,
                              anesthesia = ld_anes,
                              delivery_method = dmeth_rec,
                              ruptured_uterus = mm_rupt,
                              perineal_laceration = mm_plac,
                              plurality = dplural,
                              combined_gestation = combgest,
                              under_37weeks = gestrec3,
                              breastfed = bfed
)

birthweight_new$mother_race <- as.factor(birthweight_new$mother_race)
birthweight_new$mother_birthplace <- as.factor(birthweight_new$mother_birthplace)
birthweight_new$mother_education <- as.factor(birthweight_new$mother_education)
birthweight_new$hospital <- as.factor(birthweight_new$hospital)
birthweight_new$father_race <- as.factor(birthweight_new$father_race)
birthweight_new$mother_maritalstatus <- as.factor(birthweight_new$mother_maritalstatus)
birthweight_new$time_sincelastbirth <- as.factor(birthweight_new$time_sincelastbirth)
birthweight_new$delivery_method <- as.factor(birthweight_new$delivery_method)
birthweight_new$attend <- as.factor(birthweight_new$attend)
birthweight_new$sex <- as.factor(birthweight_new$sex)

levels(birthweight_new$mother_race) <- list("white"="10","black"="20","asian"="40","NHOPI"="50","more than 1 race"="60")
levels(birthweight_new$mother_birthplace) <- list("born in the U.S."="1","born outside the U.S."="2","unknown"="3")
levels(birthweight_new$mother_education) <- list("1-8 grade"="1","9-12 grade no HS"="2","HS diploma"="3","some college"="4","AA AS"="5","BA BS"="6","MA MS"="7","PhD EdD"="8")
levels(birthweight_new$hospital) <- list("Hospital"="1","Not Hospital"="2","Unknown"="3")
levels(birthweight_new$father_race) <- list("white"="1","black"="2","AIAN"="3","asian"="4","NHOPI"="5","more than 1 race"="6","unknown"="9")
levels(birthweight_new$mother_maritalstatus) <- list("married"="1","unmarried"="2","unmarried"="3","unknown"="9")
levels(birthweight_new$time_sincelastbirth) <- list("less than 18 months"="00","less than 18 months"="01","less than 2 years"="02","less than 2 years"="03","less than 4 years"="04","less than 4 years"="05","less than 6 years"="06","less than 6 years"="07","unknown"="99")
levels(birthweight_new$delivery_method) <- list("Vaginal"="1","Vaginal"="2","Vaginal"="5","C-section"="3","C-section"="4","C-section"="6")
levels(birthweight_new$attend) <- list("Doctor"="1","Doctor"="2","midwife"="3","midwife"="4","other"="5")  



week37to39 <- birthweight_new %>%
  filter(!is.na(birth_weight)) %>%
  filter(combined_gestation=="37" | combined_gestation=="38" | combined_gestation=="39") %>%
  filter(plurality=="1")
week37to39$time_sincelastbirth <- NULL
week37to39 <- na.omit(week37to39)



g <- ggplot(birthweight_new, aes(birth_weight)) + scale_fill_brewer(palette = "Spectral")

g + geom_histogram(aes(fill=sex),
                   binwidth = 200,
                   col="black",
                   
) + labs(title="Histogram of Birthweight",
         subtitle="Birthweight and Sex of the infant")  + scale_x_continuous(name="Birthweight, in grams",breaks=seq(0,6000,500)) + scale_y_continuous(name="Number of births",breaks=seq(0,9000,1000))
  



#boost1 = gbm(birth_weight ~ . - X - plurality - breastfed,distribution="gaussian",data=week37to39_train,interaction.depth=4,n.trees=500,shrinkage=.05)
#gbm.perf(boost1)
#boost1




#correlation 
num_cols <- unlist(lapply(birthweight_new, is.numeric))         # Identify numeric columns
data_num <- birthweight_new[, num_cols]   
data_num<-na.omit(data_num)


corr<-round(cor(data_num),2)
ggcorrplot(corr, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="square", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of birthweight variables", 
           ggtheme=theme_bw)

#summary(birthweight_new)
#remove time since last birth, not really useful 
birthweight_new$time_sincelastbirth <-NULL

#skim(birthweight_new)

#take care of missing values
birthweight_new<-na.omit(birthweight_new)

birthweight_new%>%mutate(birth_month=month(birth_month, label=TRUE), birth_time=hm(birth_time))
 
#skim(birthweight_new)

```





```{r, cache=TRUE}
set.seed(1234)
week37to39_split = initial_split(week37to39)
n = nrow(week37to39)
n_train = floor(0.8*n)
n_test = n - n_train
train_cases = sample.int(n, size=n_train, replace=FALSE)
week37to39_train = training(week37to39_split)
week37to39_test = testing(week37to39_split)



forest1 = randomForest(birth_weight ~ . - X - plurality - breastfed - under_37weeks - apgar5,distribution="gaussian",data=week37to39_train,interaction.depth=4,n.trees=500,shrinkage=.05)
yhat_test = predict(forest1,week37to39_test)
varImpPlot(forest1)
rmse(forest1,week37to39_test)
```


# **Predicting Birthright for Babies**


## **Abstract**

summary of our questions, methods, results, and conclusions in a few 100 words

## **Introduction**

Baby announcements are sweet and memorable. Expecting parents usually know their approximate due date at the beginning of the pregnancy and learn about their baby's gender at around 20 weeks mark. While gender reveal, time of birth and name of the new baby are all exciting and great news for the entire family to have, OB-GYNS mostly look at baby's development, growth and their weight. Estimating baby weight in particular is very important, since a large size baby can pose serious injuries to the baby and its mother. Ultrasounds are often used to estimate baby's weight, but they are not always accurate. When I was over 40 weeks pregnant, my doctor told me that the baby was an average size and I didnot need to be induced, however my daughter was born over 8.9lbs which was significantly larger than the estimated size and it made my delivery more complicated. So While exploring my project ideas, I came across to the NBER natality birth data from 2018 that contained the features of the baby like birth date, gender, medical conditions of the birth mother, number of children born etc. My goal is to predict the birthright of the baby depending on the week of pregnancy. Better estimations used by doctors  should mean easier deliveries and less complications and its interesting to see how machine learning tools could help us estimate the birthweight. 





## **Methods**



My dataset birthweight18.csv contains 50000 randomly chosen samples from 2018 U.S. data files
(<https://www.nber.org/research/data/vital-statistics-natality-birth-data>). There are 42 variables that were chosen from the initial 142 variables on the dataset. 




## **Data Exploration**








## **Results**

tables figs and texst that illustrate your findings. (4 -6 figures and tables do not incuudefog or table if you do not discuss it in a text)




## **Conclusion**

interpret what you founds, man lessons we should take away from your report


## **Appendix**
optional. any details figs 



--------------------------------------------------------------------------------------------------

###Data Worfklow




